@using System.Globalization
@inject FengWo.Timing.AppTimes AppTimes
@using FengWo.Web.Startup

@{
    ViewBag.CurrentPageName = PageNames.SurveyManage; // The menu item will be active for this page.
    Layout = null;
}
<script src="~/lib/vue/dist/vue.min.js"></script>
<link href="~/node_modules/element-ui/lib/theme-chalk/index.css" rel="stylesheet" />
<link href="~/node_modules/form-making/dist/FormMaking.css" rel="stylesheet" />
<script src="~/node_modules/element-ui/lib/index.js"></script>
<script src="~/node_modules/form-making/dist/FormMaking.umd.min.js"></script>
<script src="~/node_modules/form-making/public/lib/ace/src-min/ace.js"></script>

<script src="~/lib/jquery/dist/jquery.js" asp-append-version="true"></script>
<script src="~/lib/toastr/toastr.js" asp-append-version="true"></script>
<script src="~/lib/sweetalert/dist/sweetalert.min.js" asp-append-version="true"></script>
<script src="~/lib/abp-web-resources/Abp/Framework/scripts/abp.js" asp-append-version="true"></script>
<script src="~/lib/abp-web-resources/Abp/Framework/scripts/libs/abp.jquery.js" asp-append-version="true"></script>
<script src="~/lib/abp-web-resources/Abp/Framework/scripts/libs/abp.toastr.js" asp-append-version="true"></script>
<script src="~/lib/abp-web-resources/Abp/Framework/scripts/libs/abp.blockUI.js" asp-append-version="true"></script>
<script src="~/lib/abp-web-resources/Abp/Framework/scripts/libs/abp.spin.js" asp-append-version="true"></script>
<script src="~/lib/abp-web-resources/Abp/Framework/scripts/libs/abp.sweet-alert.js" asp-append-version="true"></script>
<!-- Dynamic scripts of ABP system (They are created on runtime and can not be bundled) -->
<script src="~/AbpServiceProxies/GetAll?v=@(AppTimes.StartupTime.Ticks)" type="text/javascript"></script>
<script src="~/AbpScripts/GetScripts?v=@(AppTimes.StartupTime.Ticks)" type="text/javascript"></script>
<div id="app">
    <!-- 需要设置编辑区域高度 -->
    <fm-making-form preview generate-code generate-json basic-fields="rate,radio,number,textarea,checkbox,input" layout-fields="grid,divider" :upload="true" advance-fields ref="makingform">
        <template slot="action">
            <!-- 自定义操作区域插槽 -->

            <el-button type="text" onclick="Back()" icon="el-icon-back">返回</el-button>
            <el-button type="text" onclick="Save()" icon="el-icon-upload">保存</el-button>
        </template>
    </fm-making-form>
</div>
<script>
    var id = '@ViewBag.Id';
    var dto = {};

    var parent = new Vue({
        el: '#app',
    })
    
    function Back() {
        window.location.href = '/Survey/ManageSurvey';
    }

    $(function () {
        dto.questionnaireItemId = id;
        abp.services.app.questionnaire.getQuestionnaireFormById(id, null).done(function (data) {
            var json = JSON.parse(data);
            parent.$refs.makingform.setJSON(json);
        });
    });

    function Save() {
        var json = parent.$refs.makingform.getJSON();
        dto.questionnaireForm = JSON.stringify(json);
        abp.services.app.questionnaire.createOrUpdateQuestionnaireForm(dto, null).done(function (data) {
            abp.message.success('保存成功', '', false);
        }).fail(function (data) {
            abp.message.error('保存失败,请稍后重试', '', false);
        });
    }
    //console.log(json);
</script>
